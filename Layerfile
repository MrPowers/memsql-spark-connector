FROM vm/ubuntu:18.04

# install curl, python and mysql-client
RUN sudo apt update && \
    sudo apt install -y curl python-pip mysql-client-core-5.7

# install sbt
RUN curl -L -o /tmp/sbt-1.3.5.deb https://dl.bintray.com/sbt/debian/sbt-1.3.5.deb && \
    sudo dpkg -i /tmp/sbt-1.3.5.deb &&                                               \
    sudo rm /tmp/sbt-1.3.5.deb &&                                                    \
    sudo apt-get update &&                                                           \
    sudo apt-get install -y sbt

# install the latest version of Docker
RUN apt-get update &&                                                                               \
    apt-get install apt-transport-https ca-certificates curl software-properties-common &&          \
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - &&                      \
    add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable" && \
    apt-get update &&                                                                               \
    apt install docker-ce

# install java
RUN apt-get update && \
    sudo apt-get install openjdk-8-jre

# set environment variables
ENV MEMSQL_PORT=5506
ENV MEMSQL_USER=root
ENV MEMSQL_DB=test
ENV JAVA_HOME=/usr/lib/jvm/jdk1.8.0
ENV CONTINUOUS_INTEGRATION=true
ENV SBT_OPTS=-Xmx256M
SECRET ENV LICENSE_KEY

# increase the memory
# thereâ€™s a limit to an additional 4G of memory added at once
MEMORY 4G
MEMORY 4G

# split to 9 states
# each of them will run different version of the memsql and spark
SPLIT 9

# copy the entire git repository
COPY . .

# export MEMSQL_IMAGE and SPARK_VERSION env variable for the SPLIT
RUN source ./scripts/setup-splits.sh

# start memsql cluster
RUN ./scripts/ensure-test-memsql-cluster.sh

# run tests
RUN if [ $SPARK_VERSION=='3.0.0' ];                                                \
    then                                                                           \
        sbt ++2.12.12 test -Dspark.version=$SPARK_VERION;                          \
    else                                                                           \
        sbt ++2.11.11 "testOnly -- -l  OnlySpark3" -Dspark.version=$SPARK_VERSION; \
    fi